---
title: Document and Artefact Automation
author: Kiko Fernandez-Reyes
---

As part of my work (as a programming language researcher) I need to create
artefacts that are easy to understand and well-documented. For this reason, I
found a simple way to automate the generation of source code documentation,
creation of HTML and PDFs versions of the user documentation, running tests, and
provisioning of virtual machines with all the software install.

The tools I use are:
- `Makefile` for overall orchestration of all components
- `haddock` for generation of source code documentation
- `pandoc` for generation of PDF and HTML from a Markdown file
- `vagrant` for provisioning of virtual machines
- `stack` for downloading Haskell dependencies, compiling, running tests, etc
- `pdflatex` for compilation of LaTeX file
- `bibtex` for generation of bibliography
- `zip` to pack everything and be ready for distribution

The structure I like to use has the following folder and file structure:

```
├── Makefile
├── Vagrantfile
├── code
│   └── typechecker-oopl (Project)
│       ├── Makefile
│       └── ...
│
├── documentation
│   ├── Makefile
│   ├── README.md
│   ├── assets
│   │   ├── pandoc.css (Customised CSS for Pandoc)
│   │   └── submitted-version.pdf (PDF of your research)
│   └── meta.yaml
│
├── research
│   ├── Makefile
│   ├── ACM-Reference-Format.bst
│   ├── acmart.cls
│   ├── biblio.bib
│   └── typecheckingMonad.tex
```

Let me explain a bit each file and folder. The `Makefile` will glue together the output from
all the tools mentioned above. The `code` folder contains the source code
of the tool I have produced. The `documentation` folder contains a `Makefile`
that contains instructions on how to generate a PDF and HTML version of the
`README.md` file, which contains the user instructions. The `assets` are simply
the CSS style to use and a PDF that will be hyperlinked from the user generated
documentation, so that it is easy to follow. `meta.yaml` contains meta instructions
for the generation of the documentation, used also by `pandoc` (e.g., author names).
The research folder contains my research article in `LaTeX` format, but it could be
any other technical document.

As you can see in the structure folder, I have a `Makefile` per folder to decouple
the responsibility of each `Makefile` and keep a (somewhat) maintainable design.
I provide below an overview of the top-level `Makefile`, which orchestrates the
generation of user documentation, research paper and citations, documentation
from source code, and provisioning of a virtual machine.

```Makefile
all: doc gen

doc:
	make -C $(DOC_SRC) $@
	make -C $(CODE_PATH) $@
	make -C $(RESEARCH)

gen:
	# Creation of folder with artefact, empty at the moment
	mkdir -p $(ARTEFACT_FOLDER)

	# Moving user documentation to artefact folder
	cp $(DOC_SRC)/$(README).pdf $(ARTEFACT_FOLDER)
	cp $(DOC_SRC)/$(README).html $(ARTEFACT_FOLDER)
	cp -r $(DOC_SRC)/$(ASSETS) $(ARTEFACT_FOLDER)

	# Moving research article to artefact folder
	cp $(RESEARCH)/$(RESEARCH_PAPER).pdf $(ARTEFACT_FOLDER)/$(ASSETS)/submitted-version.pdf

	# Moving code and autogenerated doc to artefact folder
	cp -r $(CODE_PATH) $(ARTEFACT_FOLDER)
	cd $(ARTEFACT_FOLDER)/$(CODE_SRC)
	$(STACK)
	cd ../..
	rm -rf $(ARTEFACT_FOLDER)/$(DOC_SRC)
	mv $(ARTEFACT_FOLDER)/$(CODE_SRC)/$(HADDOCK) $(ARTEFACT_FOLDER)/$(DOC_SRC)

	# zip it!
	zip $(ZIP_FILE) $(ARTEFACT_FOLDER)

update:
	vagrant up
	vagrant provision

clean:
	rm -rf $(ARTEFACT_FOLDER)

.PHONY: all clean doc gen update
```

The first thing we do is the `doc` target, which generates the user documentation
using `pandoc`, then we will use `haddock` to generate the documentation from
the Haskell library source code, and finally we create a PDF from the `LaTeX` file.

The user documentation is generated with the following `Makefile`:

```Makefile
DOCS=README.md
META=meta.yaml
NUMBER_SECTION_HEADINGS=-N

.PHONY: all doc clean

all: doc

doc: $(DOC)
	pandoc -s $(META) $(DOCS) --listings --pdf-engine=xelatex -c assets/pandoc.css -o $(DOCS:md=pdf)
	pandoc -s $(META) $(DOCS) --self-contained -c assets/pandoc.css -o $(DOCS:md=html)

clean:
	rm $(DOCS:md=pdf) $(DOCS:md=html)
```

To generate the documentation from Haskell code, we use this other `Makefile`,
which makes use of `stack` for compilation of the library and `haddock` (inside the `OPTS`)
to create documentation in HMTL.

```Makefile
OPTS=exec -- haddock --html --hyperlinked-source --odir=docs

doc:
	stack $(OPTS) src/Initial/AST.hs src/Initial/Typechecker.hs \
	src/Reader/AST.hs src/Reader/Typechecker.hs \
	src/Backtrace/AST.hs src/Backtrace/Typechecker.hs \
	src/Warning/AST.hs src/Warning/Typechecker.hs \
	src/MultiError/AST.hs src/MultiError/Typechecker.hs \
	src/PhantomFunctors/AST.hs src/PhantomFunctors/Typechecker.hs \
	src/PhantomPhases/AST.hs src/PhantomPhases/Typechecker.hs \
	src/Applicative/AST.hs src/Applicative/Typechecker.hs \
	src/Final/AST.hs src/Final/Typechecker.hs

.PHONY: doc
```

The research paper is compiled with the following simple `Makefile`:

```Makefile
.PHONY: research

research:
	pdflatex typecheckingMonad.tex
	bibtex typecheckingMonad
	pdflatex typecheckingMonad.tex
	pdflatex typecheckingMonad.tex
```

The virtual machine (VM) relies on `vagrant`, and the `Vagranfile` where one can
write all the commands to setup the VM. There is one thing that I do not know how to
automate and that is the inclusion of the whole documentation once is generated into
the virtual machine. If someone knows how to transfer the file from the host
machine to the VM, I would appreciate some information :)

```Vagrantfile
# All Vagrant configuration is done below. The "2" in Vagrant.configure
# configures the configuration version (we support older styles for
# backwards compatibility). Please don't change it unless you know what
# you're doing.
Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu/trusty64"
  config.ssh.username = "vagrant"
  config.ssh.password = "vagrant"
  config.vm.provider "virtualbox" do |vb|
    # Display the VirtualBox GUI when booting the machine
    vb.gui = true

    # Customize the amount of memory on the VM:
    vb.memory = "2048"
    vb.customize ["modifyvm", :id, "--vram", "64"]
  end
  config.vm.provision "shell", inline: <<-SHELL
    ## Installing dependencies, comment after this has been done once.
    # sudo apt-get update -y
    # sudo apt-get install ubuntu-desktop -y
    # sudo apt-get install -y build-essential linux-headers-server

    # echo 'PATH="/home/vagrant/.local/bin:$PATH"' >> /home/vagrant/.profile

    ## Comment and remove the folder sharing before submission
    mkdir -p /home/vagrant/Desktop/TypeChecker
    cp -r /vagrant/artefact-submission/* /home/vagrant/Desktop/TypeChecker/
    chown -R vagrant:vagrant /home/vagrant/Desktop/TypeChecker/
  SHELL
end
```

With this final step, everything has been wired. The end result can be seen
[here in HTML](https://www.plresearcher.com/files/monadic-typechecker/README.html)
and [here in PDF](https://www.plresearcher.com/files/monadic-typechecker/README.pdf).
I have created a Github repo that contains all the source code for ease of study and
reproducibility [here](https://github.com/kikofernandez/pandoc-examples/artefact-creation).

We have used this setup in two conferences, European Conference on Object-Oriented Programming (ECOOP)
and Software Language Engineering (SLE), where we won the Best Artefact Award.

Please feel free to ask questions :)
